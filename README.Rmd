---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# estatquery

<!-- badges: start -->
<!-- badges: end -->

e-Stat APIのクエリの作成・データのダウンロードを行うためのパッケージです．

このサービスは、政府統計総合窓口(e-Stat)のAPI機能を使用していますが、サービスの内容は国によって保証されたものではありません。

## インストール

CRAN上には公開されていないため，GitHubからインストールしてください．

```{r,eval=FALSE}
# install.packages("devtools")
devtools::install_github("UchidaMizuki/estatquery")
```

## データ取得の流れ

```{r,eval=FALSE}
appId <- "Your own e-Stat appId"
```

```{r,echo=FALSE}
appId <- keyring::key_get("e-Stat-appId")
```

```{r}
library(estatquery)

# estatオブジェクト作成例
my_estat <- estat$new("0003413193", appId)

# データ絞り込み例
my_estat$key$`移動後の住所地(現住地)2019～` %<>%
  filter(name == "北海道")
my_estat$key$国籍 %<>%
  filter(name == "移動者")
my_estat$key$`移動前の住所地(前住地)2019～` %<>%
  filter(level == "2")

# データ取得
my_estat$get_data()
```

## データの取得の手順
### estatオブジェクトの作成

`statsDataId`を与えて`estat`オブジェクトの作成します．
この時点では属性情報のみがダウンロードされ，データはダウンロードされません．
また，初回実行時のみappIdの（ポップアップへの）入力が必要になります（2回目以降は入力不要ですがappIdの変更にも対応しています）．

```{r}
my_estat <- estat$new("0003413193")

# appIdを再設定したい場合
# my_estat <- estat$new("0003413193",
#                         change_appId = TRUE)
```

### データ概要の確認

必要に応じて`info`でデータの概要を確認できます．

```{r}
my_estat$info
```

### 属性情報の確認

`key`で属性情報を確認できます．

```{r}
names(my_estat$key)
```

`key`には各属性情報がデータフレームで格納されます．
例として「移動後の住所地(現住地)2019～」の属性情報を示します（RStudioの補完機能により効率的にデータを参照できます）．

```{r}
my_estat$key$`移動後の住所地(現住地)2019～`
```

### 属性情報の絞り込み

`key`のデータフレームを上書きすることにより自動的に（`cdCat01`などの）クエリが作成できます（データの上書きに`magrittr`パッケージの`%<>%`を使用し，プログラムをシンプルにしています）．
今回は各都道府県（`level == 2`）から北海道に移住する人数を取得することとします（「国籍」は区別しません）．

```{r}
my_estat$key$`移動後の住所地(現住地)2019～` %<>%
  filter(name == "北海道")

my_estat$key$国籍 %<>%
  filter(name == "移動者")

my_estat$key$`移動前の住所地(前住地)2019～` %<>%
  filter(level == "2")

# 絞り込みをやり直したい場合には，`restore_key()`メソッドを実行（全てのkeyが初期化される）．
# my_estat$restore_key()
```

### データ取得

`get_data()`メソッドを実行するとデータ取得が実施され，データが出力されます（同時に`data`にデータが格納されます）．

```{r}
my_estat$get_data()
```

